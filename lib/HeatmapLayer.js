"use strict";exports.__esModule=!0,exports.computeAggregate=computeAggregate,exports["default"]=void 0;var _class,_temp,_react=_interopRequireDefault(require("react")),_lodash=_interopRequireDefault(require("lodash.map")),_lodash2=_interopRequireDefault(require("lodash.reduce")),_lodash3=_interopRequireDefault(require("lodash.filter")),_lodash4=_interopRequireDefault(require("lodash.min")),_lodash5=_interopRequireDefault(require("lodash.max")),_lodash6=_interopRequireDefault(require("lodash.isnumber")),_leaflet=_interopRequireDefault(require("leaflet")),_reactLeaflet=require("react-leaflet"),_simpleheat=_interopRequireDefault(require("simpleheat")),_propTypes=_interopRequireDefault(require("prop-types"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _inheritsLoose(a,b){a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.__proto__=b}function isInvalid(a){return!(0,_lodash6["default"])(a)&&!a}function isValid(a){return!isInvalid(a)}function isValidLatLngArray(a){return(0,_lodash3["default"])(a,isValid).length===a.length}function isInvalidLatLngArray(a){return!isValidLatLngArray(a)}function safeRemoveLayer(a,b){var c=a.getPanes(),d=c.overlayPane;d&&d.contains(b)&&d.removeChild(b)}function shouldIgnoreLocation(a){return isInvalid(a.lng)||isInvalid(a.lat)}function computeAggregate(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"sum",d=function(b,d,c){var f=a.data.mean+e.mean(a.data.mean,d,c);a.data.sigma+=(c-f)*(c-a.data.mean),a.data.mean=f},e={mean:function mean(a,b,c){return(c-a)/b},count:function count(){return 1},sum:function sum(a,b,c){return c},distinct:function distinct(b,d,c){return a.same.add(c),a.same.size},min:function min(a,b,c){return Math.min(a,c)},max:function max(a,b,c){return Math.max(a,c)},variance:function variance(b,e,c){return d(b,e,c),1<e?a.data.sigma/(e-1):0},variancep:function variancep(b,e,c){return d(b,e,c),1<e?a.data.sigma/e:0},stdev:function stdev(a,b,c){return Math.sqrt(e.variance(a,b,c))},stdevp:function stdevp(a,b,c){return Math.sqrt(e.variancep(a,b,c))}},f=c.toLowerCase();a.data[f]||("min"===f?a.data[f]=Number.MAX_SAFE_INTEGER:"max"===f?a.data[f]=Number.MIN_SAFE_INTEGER:["stdev","stdevp","variance","variancep"].includes(f)?(!a.data.mean&&(a.data.mean=0),!a.data.sigma&&(a.data.sigma=0),a.data[f]=0):a.data[f]=0);var g=(e[f]||e.sum)(a.data[f],a.seen,b);return["mean","count","sum"].includes(f)?a.data[f]+=g:a.data[f]=g,a.data[f]}var _default=(0,_reactLeaflet.withLeaflet)((_temp=_class=/*#__PURE__*/function(a){function b(){return a.apply(this,arguments)||this}_inheritsLoose(b,a);var c=b.prototype;return c.createLeafletElement=function createLeafletElement(){return null},c.componentDidMount=function componentDidMount(){var b=this,c=this.props.leaflet.map.options.zoomAnimation&&_leaflet["default"].Browser.any3d,d="leaflet-zoom-"+(c?"animated":"hide"),e=this.props.leaflet.map.getSize(),f=_leaflet["default"].DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","msTransformOrigin"]);this._el=_leaflet["default"].DomUtil.create("canvas",d),this._el.style[f]="50% 50%",this._el.width=e.x,this._el.height=e.y;var g=this._el,h=_leaflet["default"].Layer.extend({onAdd:function onAdd(a){return a.getPanes().overlayPane.appendChild(g)},addTo:function addTo(a){return a.addLayer(b),b},onRemove:function onRemove(a){return safeRemoveLayer(a,g)}});this.leafletElement=new h,a.prototype.componentDidMount.call(this),this._heatmap=(0,_simpleheat["default"])(this._el),this.reset(),this.props.fitBoundsOnLoad&&this.fitBounds(),this.attachEvents(),this.updateHeatmapProps(this.getHeatmapProps(this.props))},c.getMax=function getMax(a){return(0,_lodash6["default"])(a.max)?a.max:3},c.getRadius=function getRadius(a){return(0,_lodash6["default"])(a.radius)?a.radius:30},c.getMaxZoom=function getMaxZoom(a){return(0,_lodash6["default"])(a.maxZoom)?a.maxZoom:18},c.getOpacity=function getOpacity(a){return(0,_lodash6["default"])(a.opacity)?a.opacity:1},c.getMinOpacity=function getMinOpacity(a){return(0,_lodash6["default"])(a.minOpacity)?a.minOpacity:.01},c.getBlur=function getBlur(a){return(0,_lodash6["default"])(a.blur)?a.blur:15},c.getHeatmapProps=function getHeatmapProps(a){return{opacity:this.getOpacity(a),minOpacity:this.getMinOpacity(a),maxZoom:this.getMaxZoom(a),radius:this.getRadius(a),blur:this.getBlur(a),max:this.getMax(a),gradient:a.gradient}},c.componentWillReceiveProps=function componentWillReceiveProps(a){var b=this.props,c=this.getHeatmapProps(a);this.updateHeatmapGradient(c.gradient);var d=c.radius!==b.radius,e=c.blur!==b.blur;(d||e)&&this.updateHeatmapRadius(c.radius,c.blur),c.max!==b.max&&this.updateHeatmapMax(c.max)}/**
   * Update various heatmap properties like radius, gradient, and max
   */,c.updateHeatmapProps=function updateHeatmapProps(a){this.updateHeatmapRadius(a.radius,a.blur),this.updateHeatmapGradient(a.gradient),this.updateHeatmapMax(a.max)}/**
   * Update the heatmap's radius and blur (blur is optional)
   */,c.updateHeatmapRadius=function updateHeatmapRadius(a,b){(0,_lodash6["default"])(a)&&this._heatmap.radius(a,b)}/**
   * Update the heatmap's gradient
   */,c.updateHeatmapGradient=function updateHeatmapGradient(a){a&&this._heatmap.gradient(a)}/**
   * Update the heatmap's maximum
   */,c.updateHeatmapMax=function updateHeatmapMax(a){(0,_lodash6["default"])(a)&&this._heatmap.max(a)},c.componentWillUnmount=function componentWillUnmount(){safeRemoveLayer(this.props.leaflet.map,this._el)},c.fitBounds=function fitBounds(){var a=this.props,b=a.points,c=a.leaflet,d=a.longitudeExtractor,e=a.latitudeExtractor,f=(0,_lodash["default"])(b,d),g=(0,_lodash["default"])(b,e),h={lng:(0,_lodash5["default"])(f),lat:(0,_lodash5["default"])(g)},i={lng:(0,_lodash4["default"])(f),lat:(0,_lodash4["default"])(g)};shouldIgnoreLocation(h)||shouldIgnoreLocation(i)||c.map.fitBounds(_leaflet["default"].latLngBounds(_leaflet["default"].latLng(i),_leaflet["default"].latLng(h)))},c.componentDidUpdate=function componentDidUpdate(){this.props.leaflet.map.invalidateSize(),this.props.fitBoundsOnUpdate&&this.fitBounds(),this.reset()},c.shouldComponentUpdate=function shouldComponentUpdate(){return!0},c.attachEvents=function attachEvents(){var a=this,b=this.props.leaflet.map;b.on("viewreset",function(){return a.reset()}),b.on("moveend",function(){return a.reset()}),b.options.zoomAnimation&&_leaflet["default"].Browser.any3d&&b.on("zoomanim",this._animateZoom,this)},c._animateZoom=function _animateZoom(a){var b=this.props.leaflet.map.getZoomScale(a.zoom),c=this.props.leaflet.map._getCenterOffset(a.center)._multiplyBy(-b).subtract(this.props.leaflet.map._getMapPanePos());_leaflet["default"].DomUtil.setTransform?_leaflet["default"].DomUtil.setTransform(this._el,c,b):this._el.style[_leaflet["default"].DomUtil.TRANSFORM]=_leaflet["default"].DomUtil.getTranslateString(c)+" scale("+b+")"},c.reset=function reset(){var a=this.props.leaflet.map.containerPointToLayerPoint([0,0]);_leaflet["default"].DomUtil.setPosition(this._el,a);var b=this.props.leaflet.map.getSize();this._heatmap._width!==b.x&&(this._el.width=this._heatmap._width=b.x),this._heatmap._height!==b.y&&(this._el.height=this._heatmap._height=b.y),!this._heatmap||this._frame||this.props.leaflet.map._animating||(this._frame=_leaflet["default"].Util.requestAnimFrame(this.redraw,this)),this.redraw()},c.redraw=function redraw(){var a=this._heatmap._r,b=this.props.leaflet.map.getSize(),c=a/2,d=this.props.leaflet.map._getMapPanePos(),e=d.x%c,f=d.y%c,g=this.props.latitudeExtractor,h=this.props.longitudeExtractor,i=this.props.intensityExtractor,j=function(a,b){return b.contains(a)},k=function(a){return(0,_lodash3["default"])(a,function(a){return void 0!==a})},l=function(a){return(0,_lodash2["default"])(a,function(a,b){return(0,_lodash["default"])(k(b),function(a){return[Math.round(a[0]),Math.round(a[1]),a[2]]}).concat(a)},[])},m={},n=function(a,b,d,k){return(0,_lodash2["default"])(a,function(a,l){var n=[g(l),h(l)];//skip invalid points
if(isInvalidLatLngArray(n))return a;var o=b.latLngToContainerPoint(n);if(!j(o,d))return a;var p=Math.floor((o.x-e)/c)+2,q=Math.floor((o.y-f)/c)+2;a[q]=a[q]||[];var r=a[q][p],s=p+"-"+q;m[s]||(m[s]={data:{},same:new Set,seen:0}),m[s].seen++;var t=i(l),u=computeAggregate(m[s],t,k);return r?(r[0]=(r[0]*r[2]+o.x*u)/(r[2]+u),r[1]=(r[1]*r[2]+o.y*u)/(r[2]+u),r[2]=u):a[q][p]=[o.x,o.y,u],a},[])},o=function(){return new _leaflet["default"].Bounds(_leaflet["default"].point([-a,-a]),b.add([a,a]))},p=function getDataForHeatmap(a,b,c){return l(n(a,b,o(b),c))}(this.props.points,this.props.leaflet.map,this.props.aggregateType),q=(0,_lodash5["default"])(p.map(function(a){return a[2]}));this._heatmap.clear(),this._heatmap.data(p),this.props.useLocalExtrema&&this.updateHeatmapMax(q);try{this._heatmap.draw(this.getMinOpacity(this.props))}catch(a){// Safe to ignore - occurs if the width or height is 0
}this._frame=null,this.props.onStatsUpdate&&this.props.points&&0<this.props.points.length&&this.props.onStatsUpdate({min:(0,_lodash4["default"])(p.map(function(a){return a[2]})),max:q}),this._heatmap._canvas.style.opacity=this.getOpacity(this.props)},c.render=function render(){return null},b}(_reactLeaflet.MapLayer),_class.propTypes={points:_propTypes["default"].array.isRequired,longitudeExtractor:_propTypes["default"].func.isRequired,latitudeExtractor:_propTypes["default"].func.isRequired,intensityExtractor:_propTypes["default"].func.isRequired,fitBoundsOnLoad:_propTypes["default"].bool,fitBoundsOnUpdate:_propTypes["default"].bool,onStatsUpdate:_propTypes["default"].func,/* props controlling heatmap generation */max:_propTypes["default"].number,radius:_propTypes["default"].number,maxZoom:_propTypes["default"].number,opacity:_propTypes["default"].number,minOpacity:_propTypes["default"].number,useLocalExtrema:_propTypes["default"].bool,blur:_propTypes["default"].number,gradient:_propTypes["default"].object,aggregateType:_propTypes["default"].oneOf(["mean","count","sum","distinct","min","max","variance","variancep","stdev","stdevp"])},_temp));exports["default"]=_default;
